# 工作流名称
name: Build and Deploy to GitHub Pages (pnpm)

# 触发条件：推送到 main/master 分支时触发
on:
  push:
    branches: [ main, master ]

# 工作流任务
jobs:
  deploy:
    # 运行环境
    runs-on: ubuntu-latest

    steps:
      # 步骤1：拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整提交历史，用于检测commit信息

      # 步骤2：检测最新commit信息（核心：只在commit包含[deploy]时继续）
      - name: Check commit message
        id: check_commit
        run: |
          # 获取最新一次commit的信息
          LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "最新Commit信息：$LAST_COMMIT_MSG"
          
          # 检测是否包含[deploy]关键词（可自定义规则）
          if [[ $LAST_COMMIT_MSG == *"[deploy]"* ]]; then
            echo "✅ Commit包含部署指令，继续执行部署"
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Commit未包含[deploy]，跳过部署"
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      # 步骤3：安装Node环境
      - name: Set up Node.js
        if: steps.check_commit.outputs.deploy == 'true'  # 只有检测通过才执行
        uses: actions/setup-node@v4
        with:
          node-version: 20  # 根据你的项目调整Node版本（如18）

      # 步骤4：安装pnpm包管理器
      - name: Install pnpm
        if: steps.check_commit.outputs.deploy == 'true'
        run: npm install -g pnpm  # 使用npm全局安装pnpm
      
      # 步骤4b：验证pnpm安装
      - name: Verify pnpm installation
        if: steps.check_commit.outputs.deploy == 'true'
        run: pnpm --version

      # 步骤5：安装依赖并打包（替换为pnpm命令）
      - name: Install dependencies and build
        if: steps.check_commit.outputs.deploy == 'true'
        run: |
          pnpm install --frozen-lockfile  # 锁定依赖版本，避免意外更新（pnpm推荐写法）
          pnpm run build                  # 执行打包命令（和你本地运行的一致）

      # 步骤6：部署到GitHub Pages
      - name: Deploy to GitHub Pages
        if: steps.check_commit.outputs.deploy == 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # 注意：根据你的项目调整打包目录（Vue→dist，React→build，Next.js→out）
          publish_dir: ./dist
          publish_branch: gh-pages