# 工作流名称
name: Build and Deploy to GitHub Pages (yarn)

# 触发条件：推送到 main/master 分支时触发
on:
  push:
    branches: [ main, master ]

# 工作流任务
jobs:
  deploy:
    # 运行环境（Ubuntu 默认预装 yarn）
    runs-on: ubuntu-latest

    steps:
      # 步骤1：拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整提交历史，用于检测commit信息

      # 步骤2：检测最新commit信息（核心：含[deploy]才触发）
      - name: Check commit message
        id: check_commit
        run: |
          LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "最新Commit信息：$LAST_COMMIT_MSG"
          
          # 检测是否包含[deploy]关键词（可自定义，如[发布]、[上线]）
          if [[ $LAST_COMMIT_MSG == *"[deploy]"* ]]; then
            echo "✅ Commit包含部署指令，继续执行部署"
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Commit未包含[deploy]，跳过部署"
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      # 步骤3：安装Node环境（仅检测通过时执行）
      - name: Set up Node.js
        if: steps.check_commit.outputs.deploy == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20  # 根据你的项目调整Node版本（如18）
          cache: 'yarn'     # 缓存yarn依赖，加速构建

      # 步骤4：安装依赖并执行yarn build打包
      - name: Install dependencies and build with yarn
        if: steps.check_commit.outputs.deploy == 'true'
        run: |
          # yarn install --frozen-lockfile 锁定版本（可选，和yarn install效果一致）
          yarn install  # 环境自带yarn，直接执行即可
          yarn build    # 触发打包命令（和你本地运行的一致）

      # 步骤5：部署到GitHub Pages
      - name: Deploy to GitHub Pages
        if: steps.check_commit.outputs.deploy == 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # 打包输出目录：Vue→dist，React→build，Next.js→out（根据你的项目调整）
          publish_dir: ./dist
          publish_branch: gh-pages  # 部署到gh-pages分支